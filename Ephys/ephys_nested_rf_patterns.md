---
title: Patterns
parent: How to make the protocols
has_children: true
has_toc: true
nav_order: 100
layout: home
---

Patterns used in the `nested_rf_protocol`.
How they are made.

1. TOC
{:toc}


# Protocol 1 patterns

## P1 flashes


# Protocol 2 patterns

## P2 flashes

## P2 bars

The bar stimuli are made.

1. Pre-make the full-field bar stimuli. 

Using the `G4_pattern_generator_gui` full field bar stimuli were made. A single vertical bar stimulus was made, 4 pixels width, then the "rotation" of the arena was updated to get the patterns in the 8 different orientations (1/8 pi). These patterns were saved in `\results\patterns\protocol2\full_field_bars` or after July 2025 changed to lower contrast bars (background = 4 not 6) `\results\patterns\protocol2\full_field_bars`. 
The patterns 0015 and 0016 (OFF bars at 6/8 and 7/8pi) were updated in OCTOBER 2025 (15/10/2025). Previously, they were moving in the opposite direction to the other bar stimuli. This has been corrected now. The processing scripts will also need to be updated. 

![G4_pattern_generator_gui view when making the full field bar stimuli.]({{ site.baseurl }}/assets/imgs/ephys/nested_RF_stimulus/patterns/0001.png){:standalone .ifr_center .pop}

- Pattern: Square grating
- Step size (deg): 1.25
- Spatial wavelength: 360
- Duty cycle: 1.125
- Motion Type: Rotation
- Orientation of motion: full-field
- Pole longitude: 0 
- Pole latitude: -90
- Brightness: 4 bits
- 1st level: 0 
- 2nd level: 4

288 frames. 

Configure Arena:
- Arena rotation (roll): 2.7489 radians for (7/8*pi)

![G4_pattern_generator_gui view when making the full field bar stimuli. Configure arena pop-up.]({{ site.baseurl }}/assets/imgs/ephys/nested_RF_stimulus/patterns/0002.png){:standalone .ifr_center .pop}

More options: 
- Shift pattern in starting phase: 44

![G4_pattern_generator_gui view when making the full field bar stimuli. More options pop-up.]({{ site.baseurl }}/assets/imgs/ephys/nested_RF_stimulus/patterns/0003.png){:standalone .ifr_center .pop}


2. How to make the cropped bar patterns. 

As `generate_protocol2` is being run, there is a function that crops these full field patterns based on the "window size" specified by params used when running the function. 

Within the function `generate_bar_patterns_xy` these full field bar patterns are cropped around the centre of the pattern, corresponding to pixel numbers [24, 96]. The full field patterns are cropped based upon the value of `px_crop` which determines the size of the "window size" within which the bar stimuli are presented. This cropped area is then added to the final pattern in a location centred upon the centre of the flash stimulus from protocol 1 that elicited the greatest response. The cropped patterns are saved within the experiment folder. 

[ Img of what the cropped bar pattern looks like. ]

Each pattern is made up of 288 frames... Not 100% sure where this number comes from.

The actual frames shown is determined by the position function. 

3. Make the position functions

The position functions that determine the presentation of the bar stimuli are generated by the function `generate_bar_pos_fns`. 
This script generates the position functions programmatically, not using the GUI, but you can view the position function structure in the GUI after if desired.  

[ Img of what the position function generator looks like.]

The same position function can be used for the patterns moving in different directions. Different position functions must be created for different speeds, different px_crop "window sizes" and for the two different directions.  
The position functions used for the bar stimuli are relatively simple, comprising a 1s static period followed by a sawtooth movement that goes from the start frame or `fr_low` to the end frame `fr_high` within a given duration `dur`. Setting the parameter `flip` to 1 reverses the direction of movement and so will move the pattern from `fr_high` to `fr_low`. 




## STATIC BAR FLASHES

For pattern 0001 - vertical bars. 

Middle of the arena [48, 192] = [24, 96]. 
Frame 30 = bar in the middle. 

13 = off left. 
47 = off right









The static function is made by `generate_static_function` within `create_protocol2`. 



# How to add new stimuli. 

## P2

### Bars

Adding new bar stimuli to P2. 

Add bar flashes.

Add a faster speed of bar sweeps. 


`create_protocol2` will 